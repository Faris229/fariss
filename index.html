<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Homework ‚Äî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --brand:#4f46e5; --brand-2:#22c55e; --accent:#f59e0b; --danger:#ef4444; --ok:#10b981;
      --ring: 0 0 0 3px rgba(79,70,229,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,'Noto Sans Thai',sans-serif; background:var(--bg); color:var(--ink)}
    header{position:sticky; top:0; z-index:20; background:linear-gradient(180deg,#fff,rgba(255,255,255,.92)); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid #e5e7eb}
    .wrap{max-width:1000px; margin:0 auto; padding:16px}
    .title{display:flex; align-items:center; gap:12px}
    .logo{width:36px; height:36px; border-radius:12px; background:conic-gradient(from 180deg,var(--brand),#60a5fa,#22c55e,#f59e0b,var(--brand)); box-shadow:0 6px 20px rgba(79,70,229,.2)}
    h1{font-size:20px; margin:0}
    .subtitle{color:var(--muted); font-size:13px}

    /* layout */
    .grid{display:grid; grid-template-columns:360px 1fr; gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    /* card */
    .card{background:var(--card); border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 10px 30px rgba(17,24,39,.04)}
    .card h2{margin:0 0 8px; font-size:18px}
    .card .body{padding:16px}

    /* form */
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input, select, textarea, button{font:inherit}
    .field{margin-bottom:12px}
    .row{display:grid; gap:10px; grid-template-columns:1fr 1fr}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    input[type="text"], input[type="date"], input[type="time"], input[type="datetime-local"], select, textarea{
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; outline:none; transition:.15s;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, select:focus, textarea:focus{box-shadow:var(--ring); border-color:#c7d2fe}

    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid transparent; background:var(--brand); color:#fff; cursor:pointer; transition:.2s; text-decoration:none}
    .btn:hover{filter:brightness(1.05)}
    .btn.secondary{background:#fff; color:var(--ink); border-color:#e5e7eb}
    .btn.ghost{background:transparent; color:var(--ink); border-color:#e5e7eb}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--accent)}
    .btn.danger{background:var(--danger)}

    .toolbar{display:flex; flex-wrap:wrap; gap:8px}

    /* list */
    .list{display:grid; gap:12px; padding:12px}
    .item{display:grid; grid-template-columns:1fr auto; gap:10px; padding:14px; border:1px solid #e5e7eb; border-radius:14px; background:#fff; align-items:center}
    .item:hover{box-shadow:0 8px 22px rgba(0,0,0,.05)}
    .meta{display:flex; gap:10px; flex-wrap:wrap; font-size:12px; color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb}
    .badge.ok{background:#ecfdf5; color:#065f46; border-color:#d1fae5}
    .badge.due{background:#fff7ed; color:#9a3412; border-color:#fed7aa}
    .badge.late{background:#fef2f2; color:#991b1b; border-color:#fecaca}

    .searchbar{display:flex; gap:8px; flex-wrap:wrap; padding:8px}
    .searchbar input{flex:1}

    .empty{padding:24px; text-align:center; color:var(--muted)}

    .footer{padding:16px; text-align:center; color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô <span class="subtitle">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á, ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á, ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span></h1>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:14px; padding-bottom:24px;">
    <div class="grid">

      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° + ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
      <section class="card">
        <div class="body">
          <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h2>
          <form id="hwForm">
            <div class="field">
              <label for="subject">‡∏ß‡∏¥‡∏ä‡∏≤</label>
              <div class="row">
                <select id="subject">
                  <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                  <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                  <option value="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
                  <option value="‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©">‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</option>
                  <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                  <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ‚Ä¶ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)</option>
                </select>
                <input id="subjectCustom" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏≠‡∏á" style="display:none">
              </div>
            </div>

            <div class="field row">
              <div>
                <label for="assigned">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</label>
                <input id="assigned" type="date" required>
              </div>
              <div>
                <label for="due">‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á</label>
                <input id="due" type="datetime-local" required>
              </div>
            </div>

            <div class="field">
              <label for="detail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
              <textarea id="detail" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤ 25 ‡∏Ç‡πâ‡∏≠ 1-10"></textarea>
            </div>

            <div class="toolbar">
              <button class="btn" type="submit">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</button>
              <button class="btn secondary" type="reset" id="resetBtn">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
            </div>
          </form>

          <hr style="margin:16px 0; border:none; border-top:1px solid #e5e7eb">

          <h2>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
          <div class="field">
            <div class="toolbar">
              <button class="btn ghost" id="permBtn">üîî ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
              <button class="btn ghost" id="testNoti">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
              <button class="btn ghost" id="testSound">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á</button>
            </div>
            <p class="subtitle" style="margin-top:8px">* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏≤‡∏á‡∏£‡∏∏‡πà‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏î‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</p>
          </div>
        </div>
      </section>

      <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô -->
      <section class="card">
        <div class="body">
          <h2>‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
          <div class="searchbar">
            <input id="q" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢ ‡∏ß‡∏¥‡∏ä‡∏≤/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
            <select id="statusFilter" style="max-width:210px">
              <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="todo">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥</option>
              <option value="done">‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</option>
              <option value="late">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option>
            </select>
          </div>
          <div class="list" id="list"></div>
          <div class="empty" id="empty" style="display:none">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞</div>
        </div>
      </section>

    </div>

    <div class="footer">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Local Storage) ‚Äî ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ</div>
  </main>

  <audio id="ding" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAAACAAAC4AAAACAAACcQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mp3">
  </audio>

  <script>
  ;(()=>{
    const $ = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>[...root.querySelectorAll(q)];

    /*** STATE ***/
    const LS_KEY = 'homework.v1';
    let items = load();
    let timeouts = new Map();
    let leadMinutes = 30; // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)

    function load(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{ return [] }
    }
    function save(){ localStorage.setItem(LS_KEY, JSON.stringify(items)); }

    /*** UTIL ***/
    const fmt = new Intl.DateTimeFormat('th-TH',{dateStyle:'medium', timeStyle:'short'});
    const fmtDate = new Intl.DateTimeFormat('th-TH',{dateStyle:'medium'});
    function now(){ return Date.now(); }
    function isLate(it){ return !it.done && new Date(it.due).getTime() < now(); }
    function timeLeft(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(s/86400), h = Math.floor((s%86400)/3600), m = Math.floor((s%3600)/60);
      if(d>0) return `${d} ‡∏ß‡∏±‡∏ô ${h} ‡∏ä‡∏°.`; if(h>0) return `${h} ‡∏ä‡∏°. ${m} ‡∏ô‡∏≤‡∏ó‡∏µ`; return `${m} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    }

    /*** SUBJECT input toggle ***/
    const subjectSel = $('#subject');
    const subjectCustom = $('#subjectCustom');
    subjectSel.addEventListener('change',()=>{
      const custom = subjectSel.value.includes('‡∏≠‡∏∑‡πà‡∏ô');
      subjectCustom.style.display = custom ? 'block' : 'none';
      if(custom) subjectCustom.focus();
    });

    /*** FORM submit ***/
    $('#hwForm').addEventListener('submit', e=>{
      e.preventDefault();
      const subject = subjectSel.value.includes('‡∏≠‡∏∑‡πà‡∏ô') ? subjectCustom.value.trim() : subjectSel.value;
      if(!subject){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤'); return; }
      const assigned = $('#assigned').value;
      const due = $('#due').value;
      if(!assigned || !due){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á'); return; }
      const detail = $('#detail').value.trim();

      const it = { id: crypto.randomUUID(), subject, assigned, due, detail, done:false, createdAt: now() };
      items.unshift(it); save();
      $('#hwForm').reset(); subjectCustom.style.display='none';
      render(); scheduleOne(it);
    });

    $('#resetBtn').addEventListener('click',()=>{ subjectCustom.style.display='none'; });

    /*** RENDER ***/
    const list = $('#list'); const empty = $('#empty');
    const q = $('#q'); const statusFilter = $('#statusFilter');
    q.addEventListener('input', render); statusFilter.addEventListener('change', render);

    function render(){
      list.innerHTML='';
      const term = q.value.toLowerCase();
      const filtered = items.filter(it=>{
        const match = (it.subject+" "+it.detail).toLowerCase().includes(term);
        const late = isLate(it);
        if(statusFilter.value==='todo') return match && !it.done && !late;
        if(statusFilter.value==='done') return match && it.done;
        if(statusFilter.value==='late') return match && late;
        return match;
      });

      if(filtered.length===0){ empty.style.display='block'; return } else empty.style.display='none';

      for(const it of filtered){
        const dueTs = new Date(it.due).getTime();
        const late = isLate(it);
        const wrap = document.createElement('div'); wrap.className='item';
        const left = document.createElement('div');
        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';

        left.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap">
            <strong style="font-size:16px">${escapeHtml(it.subject)}</strong>
            ${badge(it)}
          </div>
          <div class="meta">
            <span>‡∏™‡∏±‡πà‡∏á: ${fmtDate.format(new Date(it.assigned))}</span>
            <span>‡∏™‡πà‡∏á: ${fmt.format(new Date(it.due))}</span>
            ${!it.done ? `<span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${late?'<b style="color:#b91c1c">‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</b>': timeLeft(dueTs-now())}</span>`:''}
          </div>
          ${it.detail?`<div style="margin-top:6px">${escapeHtml(it.detail)}</div>`:''}
        `;

        const btnDone = button(it.done? '‡∏¢‡πâ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥' : '‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß', it.done? 'warn' : 'ok', ()=>{
          it.done = !it.done; save(); render();
        });
        const btnBell = button('‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤', 'ghost', ()=>{
          const m = prompt('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ?', String(leadMinutes));
          if(m===null) return; const n = parseInt(m,10); if(Number.isNaN(n) || n<0){ alert('‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ô‡∏≤‡∏ó‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
          leadMinutes = n; scheduleOne(it,true);
        });
        const btnEdit = button('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç','secondary',()=> editItem(it));
        const btnDel  = button('‡∏•‡∏ö','danger',()=>{ if(confirm('‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')){ cancelSchedule(it.id); items=items.filter(x=>x.id!==it.id); save(); render(); } });

        right.append(btnDone, btnBell, btnEdit, btnDel);
        wrap.append(left, right); list.append(wrap);
      }
    }

    function badge(it){
      if(it.done) return `<span class="badge ok">‚úîÔ∏è ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>`;
      if(isLate(it)) return `<span class="badge late">‚è∞ ‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>`;
      return `<span class="badge due">üìù ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥</span>`;
    }

    function button(text, kind, onClick){
      const b = document.createElement('button'); b.className = `btn ${kind}`; b.type='button'; b.textContent=text; b.addEventListener('click', onClick); return b;
    }

    function editItem(it){
      const subject = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏¥‡∏ä‡∏≤', it.subject); if(subject===null) return;
      const assigned = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á (YYYY-MM-DD)', it.assigned); if(assigned===null) return;
      const due = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á (YYYY-MM-DDTHH:MM)', it.due.slice(0,16)); if(due===null) return;
      const detail = prompt('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', it.detail||''); if(detail===null) return;
      Object.assign(it,{subject,assigned,due,detail}); save(); render(); scheduleOne(it);
    }

    function escapeHtml(s){ return s.replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    /*** NOTIFICATION + SOUND ***/
    const permBtn = $('#permBtn');
    const testNoti = $('#testNoti');
    const testSound = $('#testSound');
    const ding = $('#ding');

    permBtn.addEventListener('click', askPermission);
    testNoti.addEventListener('click', ()=> notify('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß üéâ'));
    testSound.addEventListener('click', ()=> playDing());

    async function askPermission(){
      try{
        if('Notification' in window){
          const res = await Notification.requestPermission();
          alert('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: '+res);
        }else{
          alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Notification API');
        }
      }catch(e){ console.error(e); alert('‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); }
    }

    async function notify(title, body){
      try{
        if(!('Notification' in window)) return;
        if(Notification.permission==='granted'){
          if(navigator.serviceWorker?.controller){
            const reg = await navigator.serviceWorker.getRegistration();
            if(reg) { reg.showNotification(title,{ body, icon: undefined, badge: undefined }); }
            else new Notification(title,{ body });
          }else{
            new Notification(title,{ body });
          }
        }
      }catch(e){ console.warn('notify error', e); }
    }

    function playDing(){ try{ ding.currentTime=0; ding.play(); if(navigator.vibrate) navigator.vibrate([100,50,100]); }catch{} }

    /*** SCHEDULE ***/
    function scheduleAll(){
      // clear
      for(const id of timeouts.keys()) cancelSchedule(id);
      for(const it of items) scheduleOne(it);
    }

    function scheduleOne(it, showToast=false){
      cancelSchedule(it.id);
      if(it.done) return;
      const due = new Date(it.due).getTime();
      const when = due - leadMinutes*60*1000;
      const delay = when - now();
      if(delay <= 0){ return; }
      const tid = setTimeout(()=>{
        notify(`‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ${it.subject}`, `‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡πÉ‡∏ô ${leadMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ`);
        playDing();
      }, Math.min(delay, 2**31-1));
      timeouts.set(it.id, tid);
      if(showToast) alert(`‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ ${leadMinutes} ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤ ${it.subject}`);
    }

    function cancelSchedule(id){ const t = timeouts.get(id); if(t){ clearTimeout(t); timeouts.delete(id); } }

    /*** SERVICE WORKER (inline) ***/
    if('serviceWorker' in navigator){
      const code = `self.addEventListener('install',e=>self.skipWaiting()); self.addEventListener('activate',e=>self.clients.claim());`;
      const blob = new Blob([code],{type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(()=>{});
    }

    // init
    render(); scheduleAll();

    // live countdown refresh (‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
    setInterval(()=>{ if(document.hidden) return; render(); }, 30000);
  })();
  </script>
</body>
</html>
